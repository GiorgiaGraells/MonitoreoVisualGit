---
title: "Ms Habitat aves. Species composition in coastal urban habitats"
author: "Giorgia Graells"
  date: "`r Sys.Date()`"
  output:
    bookdown::word_document2:
      fig_caption: true 
bibliography: tesis_ref_2020.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,	message = FALSE,warning = FALSE,cache = TRUE,comment = FALSE)

library(readxl)
library(tidyverse)
library(vegan)
library(MASS)
library(ggplot2)
library(ggrepel)
library(patchwork)
library(kableExtra)
library(knitr)

```


```{r}
#preparacion de datos registro aves

AvesInv2 <- read_rds("AbundInv_Corregido.rds") 
AvesInv2 <-AvesInv2 %>% ungroup() %>% dplyr::select(-Sitio) %>% mutate_all(~replace(., is.na(.), 0)) %>% sqrt()

AvesPrim2 <- read_rds("AbundPrim_Corregido.rds")
AvesPrim2 <-AvesPrim2 %>% ungroup() %>% dplyr::select(-Sitio)%>% mutate_all(~replace(., is.na(.), 0)) %>% sqrt()

#Datos ambientales  incluidos buffers

Amb<- read_rds("/home/giorgia/Documents/Doctorado tesis/Monitoreo aves/MonitoreoVisualGit/Occdata_occu.rds")
Amb <- Amb %>% 
  dplyr::select(Sitio,CobVeg, AMBIENTE, Distancia_rio, Altura, `Buffer_2200_Bosque Nativo`, `Buffer_2200_Cultivos`, `Buffer_2200_Grava`, `Buffer_2200_Oceano`, `Buffer_2200_Pastizales`, `Buffer_2200_Matorrales`, `Buffer_2200_Sup impermeables`, `Buffer_2200_Suelo arenoso`, `Buffer_2200_Plantación de árboles`) %>% 
  rename( `Vegetation cover` =CobVeg) %>% rename( `Distance to river` =Distancia_rio) %>% 
  rename( `Native forest` =`Buffer_2200_Bosque Nativo`) %>% rename(Crops =`Buffer_2200_Cultivos`) %>% 
  rename( Gravel =`Buffer_2200_Grava`) %>% rename( Ocean =`Buffer_2200_Oceano`) %>% 
  rename( Grassland =`Buffer_2200_Pastizales`) %>% rename( `Shrublands` =`Buffer_2200_Matorrales`) %>% 
  rename( `Paved surface` =`Buffer_2200_Sup impermeables`) %>% rename( `Sand` =`Buffer_2200_Suelo arenoso`) %>% 
  rename( `Tree plantation` =`Buffer_2200_Plantación de árboles`) %>% 
  rename( Altitude = Altura)

rownames(Amb) <- Amb$Sitio

Amb <- Amb %>% dplyr::select(-Sitio)
```


#### Introduction

1. Establish importance of the fild- provide background, keywords- present the problem

[Stablish the importance of this research topic]

Urbanization have been growing rapidly ...
and is one of the mayor causes of species loss [@czech2000economic].

[Provide general background information]
Urban modificacion over natural environments has promoted loss of native species and their replacement by non-native species [@mckinney2006urbanization]. This is called biotic homogenization, where few species are adapted to urban and suburban conditions [@mckinney1999biotic]. 
Biotic homogenization affects variety of ecosystems [grassland: @zeeman2017biotic], climates [temperate: @zeeman2017biotic],taxonomic groups [mainly in birds and plants, but also insects: @knop2016biotic] 

[Stablish the importance of this research topic, more specific/detailed way]
This urban homogenization has effects: 
a. more homogenized biosfera with lower diversity, where there will be many species losers and few winners [@mckinney1999biotic].
which has been studied mostly in birds and plants

[Provide general background information, more specific/detailed way]
In birds, urban homogenization in more specific: has a nonrandom filtering effect on birds, they show guildsresponse to urbanization [@silva2016nonrandom].
Composición de aves urbanas depende más de la composición de aves urbanas aledañas que de los ambientes naturales que los rodean
Rural birds
According to @clergeau2001urban, urban  bird  communities  are  independent of the bird diversity of adjacent landscapes, and that local features are more important than surrounding landscapes. 

2. Previous an current research and contributions

[Describe general problem area or the current research focus of the field]
half of population live in coastal cities, however urbanization has been msotly focus in terrestiral aspects.

[Provide transition between the general problem area and the literature review]
More than the half of the cities in the world are coastal cities and they lack of studies addressing marine and terrestrial interactions.

3. Locate the gap-describe the proble to address-present a prediction to be tested

[Provide brief overview of key research projects in this area]
Urban homogenization has been studied in cities, focused in terrestrial variables
Considering Birs comunities in urban areas depend of the perurban composition of species, there are no studies in the effects of marine habitats

[Describe gaps in the research]
There is a gap in studies that focus in coastal ecotone and the influence of antrhopized areas
focusing on marine and terrestrial interaction of species in an urbanized area and how birds use this as habitats

[Decribe paper itself]
This research aim to identified the use of coastal urban habitats by birds describing the composition of species in differrent environments, considering bird species origin (marine and terrestrial).
with the aim of: 1. Identify bird species assemble of habitats in coastal urban environments, specifically the interaction between marine and inland birds, 2. identify how urbanization affects those bird assembles, 3. Evaluate iconic bird species habitat ocupation, and 4. describe bird behavior in those habitats

4. Describe the present paper
[Give details about the methodology reported in the paper]
The present study was carried out in the Gran Valparaíso, a metropolitan area that includes three municipalities in central Chile

[Announces the findings]
Urban habitats in coastal areas present the conditions that allow specific species composition, cohabiting marine and inlsnd bird species

#### Metodology

1. Overview-purpose of the work-give source of material/equipment used

[General overview of this section]
In this research we conducted bird surveys in six coastal urban environments in the Gran Valparaíso, a Metropolitan area in Central Chile. We estimated species composition based on bird presence analised using occupancy models.

[Provide background information and justification]
Coastal central chile present a rapid urbanization growth since the last... years, endengering natural habitats. 
The area is near by the chilean capital which has close to 6 million inhabitants.
This area is inmerse ina a natural-rural matrix composed ... in a grographic Coastal mountain chain-- papers bahi concon y viña

[Provide an overview of the procedure/method itself]
species composition were analised with the package vegan for RStudio using corrected abundance of species. Bird abundance was corrected by detection capacity using occupancy models. 
  
2. Details about materials and methods- justify choices

[Provide details about what was done and used and shows that care was taken]
Six coastal habitat were defined in terms of its proximity to the coast, level of anthropotization and land cover: urban centre, green area, natural rocky shore, modified rocky shore, natural beach, and urbanized beach (Table 1). 
Six replicas of theses habitats were sampled by visual bird surveys in south hemisfer winter and spring of 2019. Surveys were conducted randomly during sunrise and the three hours later for 10 minutes, registering species and behaviour.

Seasonality was tested with a mixed GLM with abundance as a response variable and a random effect of sample sites. We tested a model where seasonality has a interacttion with the habitats defined in this research.


[Continuing to describe what was done in detail, using languajge which comunicate that care was taken]
Bird commmunities were analised using ordination methods with vegan package in R with species abundances corrected by detection capacity, using occupancy models (see table) [].
We  determined dissimilarity distances among sample sites and tested significant differences among habitat with analysis of similarities (ANOSIM).  To determine species contribution to the differrence between habitats we used Bray-Curtis dissimilaries with SIMPER analysis.
Fit of environmental variables on species ordination was also tested. 
Bird behabiour was counted for each habitat.



3. Relate to other studies

[Describe what was done by referring to existing mehods in the literature]
To independize us from habitats already defined, ocupancy models of eight species were analize. Same species' presences were related to its behaviour detected in those habitats

[Provide more detailed information about the method and show that was a good choice]
Occupancy models provide a correction using detection probability mong days and colonization-extinction probability between seasons which improve ordination models, we used corrected abundance from probability of detection for comunity analissi


4. Indicate where problems occurred

[Mention possible difficulty in the methodology]








### Results

1. Revisting the research aim/existing research

2. General overview of results
Bird surveys in the study area detected 

A partir del nmds \@ref(Figure:NMDS)

El menor valor de AIC determina que la estacion si teiene una interaccion con las especies para definir la abundancia

```{r tabla1}
#Modelo 1= Abundancia ~ Estacion *Especie + AMBIENTE+ (1|Sitio), family = poisson, data =Aves ) #AIC 17716.1
#Modelo 2= Abundancia ~ Especie + AMBIENTE+ (1|Sitio), family = poisson, data =Aves )           #AIC 18241.0


```


3. Invitations to view results
variabilidad entre ambientes segun anosim

4. Specific/key results in details
que contribuye mas al cambio
que determina las diferencias

5. Comparisons with results in other research

6. problems with results

7. Possible impllications with results






### Discussion/Conclusion

1. Revisting previous research- summarise
[Revisit previous research]
[Revisit Introduction to recall specific weakness in methodology used in previous studies]

2. Mapping 
[Revisit methodology used in this study]
[Revisit and summarise the results]
[Show where and how the present work fits into the research "map" in this field]

3. Achivements/contributions- refining implications
[Recall an aspect of the results that represents a postitive achievement or contribution of this work]
[Focus in the meaning and implications of the achievements in this work]
[Note if one of the achievement or contributions of the work is a novelty]
[Describe implications of the results, including possible applications]

4. Limitations-current and future work-applications
[Describe limitations which should direct future research]
[Suggest a specific area to be addressed in future work]


```{r, results='hide'}
##### METAMDS: Non-metric Multidimensional scaling- NMDS

#########################################################
#Función para sacar los datos y ocupar ggplot
TidyNMDS <- function(MDS, COVS){
  DF <- COVS
  DF2 <- MDS$points %>% as.data.frame()
  DF <- bind_cols(DF2, DF)
  return(DF = DF)
}
#########################################################
#Invierno
Inv_nmds2_bray <- suppressMessages(metaMDS(AvesInv2, autotransform = FALSE, distance="bray", k=2, try=20, trymax=100,  wascores=FALSE, trace=1, plot=FALSE))
#Primavera
Prim_nmds2_bray <-suppressMessages(metaMDS(AvesPrim2,autotransform = FALSE, distance="bray", k=2, try=20, trymax=100, wascores=FALSE, trace=1, plot=FALSE)) 
```


```{r, fig.width=9, fig.height=4, fig.cap="NMDS"}
#Funcion para grafico NMDS en ggplot Invierno
Tidy_Inv_nmds2_bray <- TidyNMDS(MDS = Inv_nmds2_bray, COVS = Amb)

Inv <- ggplot(Tidy_Inv_nmds2_bray)+geom_point(aes(x=MDS1, y=MDS2, color=AMBIENTE))+theme_classic()+ 
  scale_color_manual(name="Coastal habitats", labels=c("Urbanized beach", "Natural beach", "Modified rocky shore", "Natural rocky shore","Urban centre", "Green area") , values = c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33')) + 
  ggtitle('A')

#Funcion para grafico NMDS en ggplot Primavera
Tidy_Prim_nmds2_bray <- TidyNMDS(MDS = Prim_nmds2_bray, COVS = Amb)

Prim <-ggplot(Tidy_Prim_nmds2_bray)+geom_point(aes(x=MDS1, y=MDS2, color=AMBIENTE))+theme_classic()+ 
  scale_color_manual(name="Coastal habitats", labels=c("Urbanized beach", "Natural beach", "Modified rocky shore", "Natural rocky shore","Urban centre", "Green area"), values = c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33')) + 
  ggtitle('B')

#Ambos graficos con paquete patchwork
Inv+Prim + plot_layout(guides = 'collect')
```

```{r, results='hide'}
## test: ANOSIM

#Invierno
Diss_Inv2 <- vegdist(AvesInv2, method="bray", binary=FALSE, diag=TRUE, upper=TRUE, na.rm = FALSE)
#con base de datos por abundancia
Anosim_Diss_Inv2<-anosim(Diss_Inv2, grouping=Amb$AMBIENTE, permutations = 9999, distance = "bray", strata = NULL, parallel = getOption("mc.cores"))
Summ_AnosimInv <-summary(Anosim_Diss_Inv2)

#Primavera
Diss_Prim2 <- vegdist(AvesPrim2, method="bray", binary=FALSE, diag=TRUE, upper=TRUE, na.rm = FALSE)
#con base de datos por abundancia
Anosim_Diss_Prim2<-anosim(Diss_Prim2, grouping=Amb$AMBIENTE, permutations = 9999, distance = "bray",strata = NULL, parallel = getOption("mc.cores")) 
summary(Anosim_Diss_Prim2)

```


```{r, fig.width=9}
Inv <- ggplot()+ geom_boxplot(aes(x=Anosim_Diss_Inv2$class.vec, y=Anosim_Diss_Inv2$dis.rank), notch = TRUE, varwidth=TRUE)+theme_classic()+
  xlab("Variables")+ ylab("Dissimmilarity rank")+
  ggtitle('A')

Prim <- ggplot()+ geom_boxplot(aes(Anosim_Diss_Prim2$class.vec, y=Anosim_Diss_Prim2$dis.rank), notch = TRUE, varwidth=TRUE)+theme_classic()+
 xlab("Variables")+ ylab("Dissimmilarity rank")+
   ggtitle('B')

Inv / Prim
```


```{r}
#Tabla Simper Inv

Inv <-  read.csv("ResumenSimper_Inv2.csv")

knitr::kable(
  list(Inv[1:28, ], longtable = TRUE, booktabs = TRUE
       ))

```

```{r}
#Tabla Simper Inv
Prim <-  read.csv("ResumenSimper_Prim2.csv")

knitr::kable(
  list(Prim[1:30, ], longtable = TRUE, booktabs = TRUE
       ))
```

```{r}
# set pander table-layout options
library(pander)
Prim <-  read.csv("ResumenSimper_Prim2.csv")
Prim<- as.data.frame(Prim)
panderOptions('table.alignment.default', function(Prim)
    ifelse(sapply(Prim, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

pander(Prim)

```


```{r, results='hide'}
##### ENVFIT: Fits an Environmental Vector or Factor onto an Ordination
###################################################
TidyEnvFit <- function(ENVFit, alpha = 0.05){
  DF <- ENVFit$vectors$arrows %>% as.data.frame()
  DF$Factor <- rownames(DF)
  DF$Pval <-ENVFit$vectors$pvals
  DF <- DF %>% dplyr::filter(Pval < alpha)
  return(DF = DF)
}
###################################################
EnvfitInv2 <- envfit(Inv_nmds2_bray~  `Vegetation cover`+ `Distance to river`+Altitude+ `Native forest`+ Crops+ Gravel + Ocean +Grassland+ Shrublands+`Paved surface` + `Sand`+ `Tree plantation` , data=Amb, perm=9999)
Tidy_EnvfitInv2 <- TidyEnvFit(EnvfitInv2)

EnvfitPrim2 <- envfit(Prim_nmds2_bray~  `Vegetation cover`+ `Distance to river`+Altitude+ `Native forest`+ Crops+ Gravel + Ocean +Grassland+ Shrublands+`Paved surface` + `Sand`+ `Tree plantation`, data=Amb, perm=9999)
Tidy_EnvfitPrim2 <- TidyEnvFit(EnvfitPrim2)
```


```{r,  fig.width=9, fig.height=4}
Inv <- ggplot(Tidy_Inv_nmds2_bray)+
  geom_segment(data=Tidy_EnvfitInv2, x = 0, y = 0, aes(xend =NMDS1 , yend = NMDS2), arrow = arrow(length = unit(0.2, "cm")))+
  geom_point(aes(x=MDS1, y=MDS2, color=AMBIENTE))+
  geom_text_repel(data=Tidy_EnvfitInv2, aes(x=NMDS1, y=NMDS2, label=Factor), seed = 10)+
  
  theme_classic()+ scale_color_manual(name="Coastal habitats", labels=c("Urbanized beach", "Natural beach", "Modified rocky shore", "Natural rocky shore","Urban centre", "Green area"),values = c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33'))+
  ggtitle('A')

Prim <- ggplot(Tidy_Prim_nmds2_bray)+
  geom_segment(data=Tidy_EnvfitPrim2, x = 0, y = 0, aes(xend =NMDS1 , yend = NMDS2), arrow = arrow(length = unit(0.2, "cm")))+
  geom_point(aes(x=MDS1, y=MDS2, color=AMBIENTE))+
  geom_text_repel(data=Tidy_EnvfitPrim2, aes(x=NMDS1, y=NMDS2, label=Factor), seed = 10)+
    theme_classic()+ scale_color_manual(name="Coastal habitats", labels=c("Urbanized beach", "Natural beach", "Modified rocky shore", "Natural rocky shore","Urban centre", "Green area"),values = c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33'))+
  ggtitle('B')

Inv+Prim + plot_layout(guides = 'collect')

```








### References